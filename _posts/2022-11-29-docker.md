---
layout: post
title: "Docker"
# subtitle: "This is a subtitle"
date: 2022-11-29
author: "MAI Minh"
header-img: "img/"
header-style: text
tags: [docker, cuda]
catalog: true
permalink: /distilled/docker.html
# katex: true
mathjax: true
---
<!-- <b>Last modified: <script>document.write( document.lastModified );</script> -->

### Why docker?

![](../img/container_VM.png)

Docker is a containerization solution that lets you "build, run and share applications with containers".
- can test multiple CUDA versions: [manual setup of multicuda on 1 machine](https://maiminh1996.github.io/distilled/cuda/installing-cuda.html#multi-cuda-version-on-the-one-machine) --> docker containers
- can run on different operating systems
- can easily deploy the container to cloud providers (such as AWS, Google Cloud, Azure etc.).

![](../img/docker-overview.png)

### Pre-requirement

[docker](https://docs.docker.com/engine/install/), docker-compose, and Nvidia CUDA installed on your host system

### Dockerfile

- `FROM`
- `ENV`
- `RUN`
- `WORKDIR`
- `COPY`
- `CMD`

Pre-designed images:
- <https://hub.docker.com/>
- <https://registry.hub.docker.com/r/nvidia/cuda/tags>
- <https://hub.docker.com/r/pytorch/pytorch/tags?page=1>

Docker Compose is a tool that enables us to run multiple containers at the same time by configuring them inside a docker-compose.yaml file.

### Docker image

> docker image contains set of cmd and metadata. If Docker image was like a class, docker container is an instance

Build a docker image
```txt
docker build -t <name-build-image> . # . where it contains Dockerfile
```

List, tag remove images
```txt
# Show images
docker images # list all images
# docker image ls

# set image name from image-id
docker tag <image-id> <image-names> 

# remove docker image
docker rmi <image-id> # may need to resolve conflict with dependency container 
# docker image rm <image-id
```

### Docker container

> each container is an instance of un image.

Run a container (it actually creates a new container based on the specified image). We can use VS Code --> Activity bar --> Docker to modify code, manage docker images/ container/ ...
```txt
# show all images
docker images

# create a new container
docker run -it <built-image> # run a container in interactive mode (-it), built-image: image id/ name

# list all containers
docker ps # all running containers
# docker ps -a # all containers (including stopped)
```

Stop, restart a container
```txt
# stop
docker stop <container-id> 
# docker rm <container-id>

# restart an existing container after it exited and your changes are still there.
docker start <container-id> # restart it in the background
docker attach <container-id> # reattach the terminal & stdin
```

Commit a container (intead of working on old container, we can save container changes into new image).
```txt
docker commit <container-id> <new-image-name>
```

Copy datas from container
```txt 
# copy data from a container to local machine
docker cp <container-id>:app/epoch50.pth /path/
```

```Dockerfile
FROM nvidia/cuda:10.2-cudnn8-devel-ubuntu16.04
# FROM python:latest
COPY . /app
RUN touch /app/test.txt
# COPY /app/hihi.txt ./
WORKDIR /app
```

```txt
# ls ..
# NGC-DL-CONTAINER-LICENSE  bin   dev  home  lib64  mnt  proc  run   srv  tmp  var
# app                       boot  etc  lib   media  opt  root  sbin  sys  usr

# check installed ubuntu version
cat ../etc/lsb-release 
# check installed cuda version
nvcc -V
```

### Save docker images
#### Save in local
<!-- https://dockerlabs.collabnix.com/beginners/saving-images-as-tar/ -->
#### Push into docker hub

<!-- Phương thức 	Mô tả
Docker commands / "By hand" 	Tạo 1 container với docker run và input. Tạo 1 image qua docker commit .
Dockerfile 	Xây dựng từ 1 image cơ bản, với build xác định cùng với số lượng command nhất định (recommend) .
Dockerfile và configuration management (CM) tool 	Giống Dockerfile, nhưng kiểm soát để build thêm qua cộng cụ CM tool .
Scratch image và import 1 vài file 	Từ 1 image rỗng, import 1 tar file với 1 vài file bắt buộc .


https://blog.roboflow.com/nvidia-docker-vscode-pytorch/ -->



<!-- ```dockerfile
FROM nvidia/cuda:11.0.3-cudnn8-devel-ubuntu18.04

# The submission directory contains the code and associated libraries that are
# clonein future steps.
RUN mkdir -p /code/submission
WORKDIR /code/submission

# Get packages needed for builds below.
RUN apt-get update \
  && apt-get install -y wget unzip g++ git libgl1-mesa-glx \
                        libboost-all-dev llvm-10 libsm6 libxrender-dev \
  && rm -rf /var/lib/apt/lists/*

RUN apt update && \
    apt install --no-install-recommends -y build-essential python3 python3-pip && \
    apt clean && rm -rf /var/lib/apt/lists/*

RUN apt-get update \
  && apt-get install -y python3-pip

# Install the specific version of PyTorch recommended for the libraries below.
RUN python3 -m pip install --upgrade pip \
  && python3 -m pip install torch==1.7.1+cu110 torchvision==0.8.2+cu110 -f https://download.pytorch.org/whl/torch_stable.html

# CMake is required for builds.
RUN wget https://github.com/Kitware/CMake/releases/download/v3.19.4/cmake-3.19.4-Linux-x86_64.tar.gz \
  && tar xf cmake-3.19.4-Linux-x86_64.tar.gz \
  && rm -f cmake-3.19.4-Linux-x86_64.tar.gz

ENV CUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-11.0 \
    PATH=$PATH:/code/submission/cmake-3.19.4-Linux-x86_64/bin/ \
    LLVM_CONFIG=/usr/bin/llvm-config-10 \
    PYTHONPATH=/code/submission/lib:$PYTHONPATH \
    TF_CPP_MIN_LOG_LEVEL=1 \
    CUDA_HOME=/usr/local/cuda-11.0

# Install dependency.
RUN git clone --recursive https://github.com/traveller59/spconv.git \
  && cd spconv \
  && python3 setup.py bdist_wheel \
  && cd dist \
  && python3 -m pip install *

RUN git clone https://github.com/NVIDIA/apex \
  && cd apex \
  && git checkout 5633f6  \
  && python3 -m pip install -v --no-cache-dir --global-option="--cpp_ext" --global-option="--cuda_ext" ./

COPY ./vinDet3D-CenterBased ./vinDet3D-CenterBased

ENV PYTHONPATH="${PYTHONPATH}:/code/submission/vinDet3D-CenterBased"

RUN cd vinDet3D-CenterBased \
  && python3 -m pip install -r requirements.txt \
  && bash setup.sh

# Python should default to python3 for this code.
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 0

# Copy in the folder with the submission module and download the model weights
# from https://github.com/open-mmlab/OpenPCDet/blob/master/README.md.
COPY lib /code/submission/lib

COPY ./epoch_26.pth /code/submission/lib/wod_latency_submission/WAYMO_MODEL_WEIGHTS.pth

# Set the working directly correctly so to ensure access to some config files.
WORKDIR /code/submission/vinDet3D-CenterBased
``` -->

### Mount data docker




### Debug
<!-- Why need debugging https://www.quora.com/Why-do-you-need-to-debug-when-writing-code

https://python.plainenglish.io/debugging-deep-learning-docker-containers-3815a44c9519

https://medium.com/@adityathiruvengadam/cuda-docker-%EF%B8%8F-for-deep-learning-cab7c2be67f9 -->